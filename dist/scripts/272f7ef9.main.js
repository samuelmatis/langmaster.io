Marionette.Region.Dialog=Marionette.Region.extend({onShow:function(a){this.listenTo(a,"dialog:close",this.closeDialog);var b=this;this.$el.dialog({model:!0,title:a.title,width:"auto",close:function(){b.closeDialog()}})},closeDialog:function(){this.stopListening(),this.close(),this.$el.dialog("destroy")}});var App=new Marionette.Application;App.addRegions({headerRegion:"#header",appRegion:"#app",dialogRegion:Marionette.Region.Dialog.extend({el:"#dialog-region"})}),App.navigate=function(a,b){b||(b={}),Backbone.history.navigate(a,b)},App.getCurrentRoute=function(){return Backbone.history.fragment},App.on("initialize:after",function(){Backbone.history&&(Backbone.history.start(),""===this.getCurrentRoute()&&App.trigger("words:list")),App.vent.on("app:logout",function(){window.location.replace("/api/logout")})}),App.module("Entities",function(a,b,c,d,e,f){var g=function(a){if(a.urlRoot)return f.result(a,"urlRoot");if(a.url)return f.result(a,"url");if(a.collection&&a.collection.url)return f.result(a.collection,"url");throw new Error("Unable to determine storage key")},h=function(a){var b=g(a);return{localStorage:new c.LocalStorage(b)}};a.configureStorage=function(a){f.extend(a.prototype,new h(a.prototype))}}),App.module("Entities",function(a){a.FilteredCollection=function(a){var b=a.collection,c=new b.constructor;c.add(b.models),c.filterFunction=a.filterFunction;var d=function(a,d,e){var f,e=e||b;f="filter"==d?a.trim():a;var g=[];if(f)if("filter"==d){if(!c.filterFunction)throw"Attempted to use 'filter' function, but none was defined";var h=c.filterFunction(f);g=e.filter(h)}else g=e.where(f);else g=e.models;return c._currentCriterion=f,g};return c.filter=function(a){c._currentFilter="filter";var b=d(a,"filter");return c.reset(b),c},c.where=function(a){c._currentFilter="where";var b=d(a,"where");return c.reset(b),c},b.on("reset",function(){var a=d(c._currentCriterion,c._currentFilter);c.reset(a)}),b.on("add",function(a){var e=new b.constructor;e.add(a);var f=d(c._currentCriterion,c._currentFilter,e);c.add(f)}),c}}),App.module("Entities",function(a,b,c,d,e,f){a.Header=c.Model.extend({initialize:function(){var a=new c.Picky.Selectable(this);f.extend(this,a)}}),a.HeaderCollection=c.Collection.extend({model:a.Header,initialize:function(){var a=new c.Picky.SingleSelect(this);f.extend(this,a)}});var g=function(){a.headers=new a.HeaderCollection([{name:"Home",url:"home",navigationTrigger:"home:show"},{name:"Test",url:"test",navigationTrigger:"test:main:show"},{name:"Words",url:"words",navigationTrigger:"words:list"},{name:"Profile",url:"profile",navigationTrigger:"profile:show"}])},h={getHeaders:function(){return void 0===a.headers&&g(),a.headers}};b.reqres.setHandler("header:entities",function(){return h.getHeaders()})}),App.module("Entities",function(a,b,c,d,e,f){a.Word=c.Model.extend({defaults:{word:"",translation:"",strength:0},parse:function(a){return a.id=a.word_id,delete a.word_id,delete a._id,console.log(a),a},validate:function(a){var b={};return a.word||(b.word="Can't be blank"),a.translation?a.translation.length<2&&(b.translation="Is too short"):b.translation="Can't be blank",f.isEmpty(b)?void 0:b}}),a.WordCollection=c.Collection.extend({initialize:function(){var a=e.ajax({url:"/api/users/name",async:!1});this.dat=a.responseText},url:function(){return"/api/users/"+this.dat+"/words"},model:a.Word});var g={getWordsEntities:function(){var b=new a.WordCollection,c=e.Deferred();b.fetch({success:function(a){c.resolve(a)}});var d=c.promise();return d},getWordEntity:function(b){var c=new a.Word({id:b}),d=e.Deferred();return setTimeout(function(){c.fetch({success:function(a){d.resolve(a)},error:function(){d.resolve(void 0)}})},500),d.promise()}};b.reqres.setHandler("words:entities",function(){return g.getWordsEntities()}),b.reqres.setHandler("word:entity",function(a){return g.getWordEntity(a)})}),App.module("Common.Views",function(a,b,c,d,e){a.Loading=d.ItemView.extend({template:"#loading-view",serializeData:function(){return{title:this.options.title||"Loading Data",message:this.options.message||"Please wait, data is loading"}},onShow:function(){var a={lines:13,length:26,width:2,radius:28,corners:1,rotate:0,direction:1,color:"#000",speed:1,trail:64,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2e9,top:"auto",left:"auto"};e("#spinner").spin(a)}})}),App.module("Header",function(a,b){var c={listHeader:function(){a.List.Controller.listHeader()}};b.commands.setHandler("set:active:header",function(a){b.Header.List.Controller.setActiveHeader(a)}),a.on("start",function(){c.listHeader()}),a.on("stop",function(){b.headerRegion.close()})}),App.module("Header.List",function(a,b,c,d){a.Header=d.ItemView.extend({template:"#header-link",tagName:"li",events:{"click a":"navigate"},navigate:function(a){a.preventDefault(),this.trigger("navigate",this.model)},onRender:function(){this.model.selected&&this.$el.addClass("active")}}),a.Headers=d.CompositeView.extend({template:"#header-template",tagName:"nav",className:"navbar-wrapper navbar-default navbar-fixed-top",itemView:a.Header,itemViewContainer:"ul.nav-main",events:{"click a.brand":"brandClicked","click .js-logout":"logout"},brandClicked:function(a){a.preventDefault(),this.trigger("brand:clicked")},logout:function(){b.vent.trigger("app:logout")},initialize:function(){this.$el.attr("role","navigation")}})}),App.module("Header.List",function(a,b){a.Controller={listHeader:function(){var c=b.request("header:entities"),d=new a.Headers({collection:c});d.on("brand:clicked",function(){b.trigger("contacts:list")}),d.on("itemview:navigate",function(a,c){var d=c.get("navigationTrigger");b.trigger(d)}),b.headerRegion.show(d)},setActiveHeader:function(a){var c=b.request("header:entities"),d=c.find(function(b){return b.get("url")===a});d.select(),c.trigger("reset")}}}),App.module("Words",function(a,b,c,d){a.Router=d.AppRouter.extend({appRoutes:{words:"listWords","words/(?filter=:criterion)":"filterWords","words/:id/edit":"editWord"}});var e={listWords:function(){b.Words.List.Controller.listWords(),b.execute("set:active:header","words")},filterWords:function(a){b.Words.List.Controller.listWords(a),b.execute("set:active:header","words")},editWord:function(a){b.Words.Edit.Controller.editWord(a),b.execute("set:active:header","words")}};b.on("words:list",function(){b.navigate("words"),e.listWords()}),b.on("word:edit",function(a){b.navigate("words/"+a+"/edit")}),b.on("words:filter",function(a){a?b.navigate("words?filter="+a):b.navigate("words")}),b.addInitializer(function(){new a.Router({controller:e})})}),App.module("Words.Common.Views",function(a,b,c,d,e,f){a.Form=d.ItemView.extend({template:"#words-form",events:{"click button.js-submit":"submitClicked"},submitClicked:function(a){a.preventDefault();var b=c.Syphon.serialize(this);this.trigger("form:submit",b)},onFormDataInvalid:function(a){var b=this.$el,c=function(){var a=b.find("form");a.find(".help-inline.error").each(function(){e(this).remove()}),a.find(".control-group.error").each(function(){e(this).removeClass("error")})},d=function(a,c){var d=b.find("#edit-"+c).parent(),f=e("<span>",{"class":"help-inline error",text:a});d.append(f).addClass("has-error")};c(),f.each(a,d)}})}),App.module("Words.List",function(a,b,c,d,e,f){a.Layout=d.Layout.extend({template:"#words-region-layout",className:"pure-g content-ribbon",regions:{listRegion:"#list-words",addRegion:"#add-new-word"}}),a.NewWord=d.ItemView.extend({template:"#words-list-newword",events:{"click button.js-addnewword":"submitClicked"},submitClicked:function(a){a.preventDefault();var b=c.Syphon.serialize(this);console.log(b),this.trigger("form:submit",b)},onFormDataInvalid:function(a){var b=this.$el,c=function(){var a=b.find("form");a.find(".help-inline.error").each(function(){e(this).remove()}),a.find(".control-group.error").each(function(){e(this).removeClass("error")})},d=this,g=function(a,b){var c=d.$el.find("#create-"+b).parent(),f=e("<span>",{"class":"help-inline error",text:a});c.append(f).addClass("error")};c(),f.each(a,g)}}),a.Word=d.ItemView.extend({tagName:"tr",template:"#word-list-item",events:{"click td a.js-edit":"editClicked","click button.js-delete":"deleteClicked"},flash:function(a){var b=this.$el;b.hide().toggleClass(a).fadeIn(800,function(){setTimeout(function(){b.toggleClass(a)},500)})},deleteClicked:function(a){a.preventDefault(),a.stopPropagation();var b=this;bootbox.confirm("Do you really want to remove word "+this.model.get("word")+"?",function(a){a&&b.trigger("word:delete",b.model)})},editClicked:function(a){a.preventDefault(),a.stopPropagation(),this.trigger("word:edit",this.model)}});var g=d.ItemView.extend({template:"#word-list-none",tagName:"tr",className:"warning"});a.Words=d.CompositeView.extend({template:"#word-list",emptyView:g,itemView:a.Word,itemViewContainer:"tbody",events:{"click button.js-filter":"filterClicked"},ui:{criterion:"input.js-filter-criterion"},filterClicked:function(a){a.preventDefault();var b=this.$(".js-filter-criterion").val();this.trigger("words:filter",b)},onSetFilterCriterion:function(a){e(this.ui.criterion).val(a)}})}),App.module("Words.List",function(a,b,c,d,e){a.Controller={listWords:function(c){var d=new b.Common.Views.Loading;b.appRegion.show(d);var f=b.request("words:entities");b.module("Header").start();var g=new a.Layout,h=new a.NewWord;e.when(f).done(function(d){var e=b.Entities.FilteredCollection({collection:d,filterFunction:function(a){var b=a.toLowerCase();return function(a){return-1!==a.get("word").toLowerCase().indexOf(b)||-1!==a.get("translation").toLowerCase().indexOf(b)?a:void 0}}}),f=new a.Words({collection:d});c&&(e.filter(c),f.once("show",function(){f.triggerMethod("set:filter:criterion",c)})),f.on("words:filter",function(a){e.filter(a),b.trigger("words:filter",a)}),g.on("show",function(){g.listRegion.show(f),g.addRegion.show(h)}),h.on("form:submit",function(a){var c=new b.Entities.Word;c.save(a)?(this.$("#create-word, #create-translation").val(""),this.$("#create-word").focus(),d.add({id:c.get("id"),word:c.get("word"),translation:c.get("translation")}),console.log(d),console.log("------------------------"),console.log(f),f.children.findByModel(c).flash("success")):h.triggerMethod("form:data:invalid",c.validationError)}),f.on("itemview:word:edit",function(a,c){b.trigger("word:edit",c.get("id"));var d=new b.Words.Edit.Word({model:c});d.on("form:submit",function(b){c.save(b)?(a.render(),d.trigger("dialog:close"),a.flash("success")):d.triggerMethod("form:data:invalid",c.validationError)}),b.dialogRegion.show(d)}),f.on("itemview:word:delete",function(a,b){b.destroy()}),b.appRegion.show(g)})}}}),App.module("Words.Edit",function(a,b,c,d,e){a.Word=b.Words.Common.Views.Form.extend({initialize:function(){this.title="Edit "+this.model.get("word")},onRender:function(){if(this.options.generateTitle){var a=e("<h1>",{text:this.title});this.$el.prepend(a)}this.$(".js-submit").text("Update word")}})}),App.module("Words.Edit",function(a,b,c,d,e){a.Controller={editWord:function(c){var d=new b.Common.Views.Loading;b.appRegion.show(d);var f=b.request("word:entity",c);e.when(f).done(function(c){var d;void 0!==c?(d=new a.Word({model:c,generateTitle:!0}),d.on("form:submit",function(a){c.save(a)?b.trigger("words:list"):d.triggerMethod("form:data:invalid",c.validationError)})):d=new b.Words.Show.MissingWord,b.appRegion.show(d)})}}}),App.module("Test",function(a,b,c,d){a.Router=d.AppRouter.extend({appRoutes:{test:"showTest"}});var e={showTest:function(){a.Main.Controller.showMain(),b.execute("set:active:header","test")}};b.on("test:main:show",function(){b.navigate("test"),e.showTest()}),b.addInitializer(function(){new a.Router({controller:e})})}),App.module("Test.Main",function(a,b,c,d){a.TestHeaderPanel=d.ItemView.extend({template:"#test-header-panel",tagName:"nav",className:"navbar-wrapper navbar-test navbar-default",events:{"click .js-back-to-words":"backToWords"},backToWords:function(a){a.preventDefault(),App.trigger("words:list")}}),a.StartPageWords=d.ItemView.extend({tagName:"tr",template:"#test-weakest-words"}),a.StartPage=d.CompositeView.extend({template:"#test-start",className:"col-md-4 col-md-offset-4",id:"test",itemView:a.StartPageWords,itemViewContainer:"tbody",triggers:{"click .js-start-test":"start:test"}}),a.TestLayout=d.Layout.extend({template:"#test-region-layout",className:"row",regions:{testHeader:"#test-header",testMain:"#test-main",testResult:"#test-result"}}),a.HeaderRegion=d.ItemView.extend({template:"#test-header-region",triggers:{"click .js-giveup":"test:giveup"}}),a.TestRegion=d.ItemView.extend({template:"#test-main-region",events:{"click .js-submit-answer":"submitAnswer"},submitAnswer:function(a){a.preventDefault();var b=c.Syphon.serialize(this);this.trigger("submit:answer",b)}}),a.TestResult=d.ItemView.extend({template:"#test-result-region",serializeData:function(){return"good"===this.options.result?{result:"success",result_text:"Good! :)"}:"ok"===this.options.result?{result:"warning",result_text:"You have a small typo in your answer."}:{result:"danger",result_text:"No No No!"}},triggers:{"click .js-next":"test:next"}}),a.FinalTableView=d.ItemView.extend({tagName:"tr",template:"#test-final-table"}),a.FinalView=d.CompositeView.extend({template:"#test-final",className:"col-md-4 col-md-offset-4",id:"test",itemView:a.FinalTableView,itemViewContainer:"tbody",serializeData:function(){return{result:this.options.data}},events:{"click .js-start-again":"startAgain","click .js-end-test":"testEnd"},startAgain:function(a){a.preventDefault(),App.trigger("test:main:show")},testEnd:function(a){a.preventDefault(),App.trigger("words:list")}}),a.TestNoWords=d.ItemView.extend({template:"#test-no-words",className:"col-md-6 col-md-offset-3",id:"test"})}),App.module("Test.Main",function(a,b,c,d,e,f){a.Controller={showMain:function(){b.module("Header").stop();var d=new a.TestHeaderPanel;b.headerRegion.show(d);var f=new b.Common.Views.Loading;b.appRegion.show(f);var g=b.request("words:entities");e.when(g).done(function(d){if(0!==d.size()){d.comparator=function(a){return a.get("strength")},d.sort();var e=new c.Collection(d.first(5)),f=new a.StartPage({collection:e});f.on("start:test",function(){b.Test.Main.Controller.showTest(d)}),b.appRegion.show(f)}else{var g=new a.TestNoWords;b.appRegion.show(g)}})},showTest:function(c){b.headerRegion.close();var d=new a.TestLayout,g=new a.HeaderRegion;d.on("show",function(){d.testHeader.show(g),randomWord=function(){var a=f.random(1,c.size()),b=c.at(a);return b};var h=new a.TestRegion({model:randomWord()}),i=5;h.once("show",function(){localStorage.setItem("last_word",""),console.log(h.model)}),h.on("show",function(){null===localStorage.getItem("test_word_"+this.model.get("word"))&&localStorage.setItem("test_word_"+this.model.get("word"),""),5>i&&(this.model.get("word")===localStorage.getItem("last_word")&&(h.model=randomWord(),d.testResult.close(),d.testMain.show(h),self.$("#js-submit-answer").focus()),localStorage.setItem("last_word",this.model.get("word"))),0>i&&(d.close(),b.Test.Main.Controller.showAfterTest(c))}),h.on("submit:answer",function(b){this.$(".js-submit-answer").hide(),i--;var c=this.model.get("word"),f=b.answer,g=this;e.post("api/users/petoparada/compare",{origin:c,input:f},function(b){console.log(b);var e=function(b,e){localStorage["test_word_"+c]+=e;var f=new a.TestResult({result:b});d.testResult.show(f),this.$(".js-next").focus(),f.on("test:next",function(){h.model=randomWord(),d.testResult.close(),d.testMain.show(h),g.$("#js-submit-answer").focus()})};1==b?e("good",1):1>b&&b>=.9?e("ok",1):.9>b&&e("bad",0)})}),g.on("test:giveup",function(){var c=new a.TestHeaderPanel;b.headerRegion.show(c),b.trigger("test:main:show")}),d.testMain.show(h)}),b.appRegion.show(d)},showAfterTest:function(){var d=new c.Collection;Object.keys(localStorage).forEach(function(a){if(/^test_word_.*$/.test(a)){console.log(a);var b=a.split("_")[2],c=localStorage.getItem(a);e.post("api/users/petoparada/test",{word:b,know:c},function(a){d.add({word:a.word,strength:a.strength,increase:a.increase}),localStorage.removeItem("test_word_"+a.word)})}}),localStorage.removeItem("last_word");var f=new a.FinalView({collection:d});b.appRegion.show(f)}}}),App.module("Profile",function(a,b,c,d){a.Router=d.AppRouter.extend({appRoutes:{profile:"showProfile"}});var e={showProfile:function(){b.Profile.Show.Controller.showProfile(),b.execute("set:active:header","profile")}};b.on("profile:show",function(){b.navigate("profile"),e.showProfile()}),b.addInitializer(function(){new a.Router({controller:e})})}),App.module("Profile.Show",function(a,b,c,d){a.Profile=d.ItemView.extend({template:"#profile-template",className:"pure-g content-ribbon"})}),App.module("Profile.Show",function(a,b){a.Controller={showProfile:function(){var c=new a.Profile;b.appRegion.show(c)}}});